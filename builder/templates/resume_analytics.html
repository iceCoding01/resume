{% extends 'base.html' %}
{% load static %}

{% block title %}Resume Analytics - {{ resume.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .analytics-card {
        @apply bg-white rounded-lg shadow-md p-6;
    }
    
    .stat-card {
        @apply bg-white rounded-lg shadow-md p-6 text-center;
    }
    
    .stat-value {
        @apply text-3xl font-bold;
    }
    
    .stat-label {
        @apply text-sm text-gray-500 mt-1;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .activity-item {
        @apply border-l-2 border-blue-200 pl-4 py-3;
    }
    
    .activity-item:last-child {
        @apply border-l-0;
    }
    
    .activity-dot {
        @apply absolute -left-1.5 mt-1.5 h-3 w-3 rounded-full border-2 border-white;
    }
    
    .action-viewed {
        @apply bg-green-500;
    }
    
    .action-pdf {
        @apply bg-blue-500;
    }
    
    .action-duplicated {
        @apply bg-purple-500;
    }
    
    .action-share {
        @apply bg-yellow-500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Analytics: {{ resume.title }}</h1>
            <p class="text-sm text-gray-600">Track how your resume is performing</p>
        </div>
        <div>
            <a href="{% url 'preview_resume' resume.id %}" class="btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Resume
            </a>
        </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card">
            <div class="stat-value text-blue-600">{{ view_count }}</div>
            <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-green-600">{{ download_count }}</div>
            <div class="stat-label">PDF Downloads</div>
        </div>
        <div class="stat-card">
            <div class="stat-value text-purple-600">
                {% if view_count > 0 %}
                {{ download_count|floatformat:1 }}%
                {% else %}
                0%
                {% endif %}
            </div>
            <div class="stat-label">Conversion Rate</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="analytics-card">
            <h2 class="text-lg font-medium text-gray-900 mb-4">View Trend (Last 30 Days)</h2>
            <div class="chart-container">
                <canvas id="viewTrendChart"></canvas>
            </div>
        </div>
        <div class="analytics-card">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Activity Breakdown</h2>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="analytics-card mb-8">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Recent Activity</h2>
        
        {% if analytics %}
        <div class="relative">
            {% for item in analytics %}
            <div class="activity-item relative">
                <div class="activity-dot {% if item.action == 'viewed' %}action-viewed{% elif item.action == 'pdf_generated' %}action-pdf{% elif item.action == 'duplicated' %}action-duplicated{% elif item.action == 'share_status_changed' %}action-share{% endif %}"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium text-gray-800">
                            {% if item.action == 'viewed' %}
                            Resume Viewed
                            {% elif item.action == 'pdf_generated' %}
                            PDF Downloaded
                            {% elif item.action == 'duplicated' %}
                            Resume Duplicated
                            {% elif item.action == 'share_status_changed' %}
                            Share Status Changed
                            {% else %}
                            {{ item.action|title }}
                            {% endif %}
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            {% if item.action == 'viewed' and item.metadata.referrer %}
                            Referred from: {{ item.metadata.referrer|truncatechars:50 }}
                            {% elif item.action == 'pdf_generated' and item.metadata.template %}
                            Template: {{ item.metadata.template }}
                            {% elif item.action == 'share_status_changed' %}
                            Status: {% if item.metadata.is_public %}Made Public{% else %}Made Private{% endif %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ item.created_at|date:"M d, Y" }} at {{ item.created_at|time:"g:i A" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center p-6 bg-gray-50 rounded-md">
            <p class="text-gray-600">No activity recorded yet.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Tips & Insights -->
    <div class="analytics-card">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Tips & Insights</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-blue-50 p-4 rounded-md">
                <h3 class="font-medium text-blue-800 mb-2">Improve Your Visibility</h3>
                <p class="text-blue-700 text-sm">Share your resume on LinkedIn and other professional networks to increase views.</p>
            </div>
            
            <div class="bg-green-50 p-4 rounded-md">
                <h3 class="font-medium text-green-800 mb-2">Optimize for Downloads</h3>
                <p class="text-green-700 text-sm">Resumes with clear headings and concise bullet points tend to get more downloads.</p>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-md">
                <h3 class="font-medium text-purple-800 mb-2">Test Different Templates</h3>
                <p class="text-purple-700 text-sm">Try different templates to see which one resonates better with your audience.</p>
            </div>
            
            <div class="bg-yellow-50 p-4 rounded-md">
                <h3 class="font-medium text-yellow-800 mb-2">Regular Updates</h3>
                <p class="text-yellow-700 text-sm">Keep your resume fresh with regular updates to your skills and experiences.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // View Trend Chart
        const trendLabels = {{ trend_labels|safe }};
        const trendValues = {{ trend_values|safe }};
        
        const viewTrendChart = new Chart(
            document.getElementById('viewTrendChart'),
            {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Daily Views',
                        data: trendValues,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            }
        );
        
        // Activity Breakdown Chart
        const activityChart = new Chart(
            document.getElementById('activityChart'),
            {
                type: 'doughnut',
                data: {
                    labels: ['Views', 'Downloads', 'Other Actions'],
                    datasets: [{
                        data: [{{ view_count }}, {{ download_count }}, {{ analytics.count|default:0 }} - {{ view_count }} - {{ download_count }}],
                        backgroundColor: [
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(52, 211, 153)',
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            }
        );
    });
</script>
{% endblock %}
